<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta content="yes" name="apple-mobile-web-app-capable"><!--可隐藏地址栏，仅针对IOS的Safari（注：IOS7.0版本以后，safari上已看不到效果）-->
    <meta content="yes" name="apple-touch-fullscreen"><!--添加到主屏幕后，全屏显示-->
    <meta content="telephone=no,email=no" name="format-detection"><!--IOS中禁用将数字识别为电话号码/忽略Android平台中对邮箱地址的识别-->
    <meta http-equiv="X-UA-Compatible" content="IE=Edge"/><!--避免IE使用兼容模式-->
    <meta content="black" name="apple-mobile-web-app-status-bar-style"><!--仅针对IOS的Safari顶端状态条的样式（可选default/black/black-translucent ）-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>Title</title>
</head>
<body>
<div style="width: 100%;text-align:center;">
    <button id="qCode" style="width:50vw;height: 10vw;background-color: #04be02;border: none;color: #ffffff;margin-top: 20vh">点击扫码</button>
</div>
<p style="width: 100vw;text-align:center;margin-top: 10vh;" id='p1'>扫描次数：<span>0</span></p>
<p style="width: 100vw;text-align:center;margin-top: 10vh;" id='p2'></p>
<script src="http://res.wx.qq.com/open/js/jweixin-1.4.0.js"></script>
<script src="js/zepto.min.js"></script>
<!-- <script src="js/index.js"></script> -->
<script>

var pageUrl = window.location.href;

let timer = 0;

$.ajax({
	url : '/wxjs/getShareToken',
	type : 'get',
	data : {
		pageUrl : pageUrl
	},
	dataType : 'json',
	success : function(data) {
		wx.config({
			debug : false, // 开启调试模式,调用的所有api的返回值会在客户端alert出来
			appId : data.appId, // 必填，公众号的唯一标识
			timestamp : data.timestamp, // 必填，生成签名的时间戳
			nonceStr : data.nonceStr, // 必填，生成签名的随机串
			signature : data.signature,// 必填，签名，见附录1
			jsApiList: [
	            'scanQRCode'
	        ]
		});
		
		wx.ready(function () {
			//alert("ready--->");
		});
		
		wx.error(function(res) {
			//alert("error--->" + res.errMsg);
		});

	}
});

//9 微信原生接口
// 9.1.2 扫描二维码并返回结果
document.querySelector('#qCode').onclick = function () {
    qCode();
};

function qCode(){
    wx.scanQRCode({
        needResult: 1,
        desc: '扫码返回结果',
        success: function (res) {
            // 每扫描成功一次次数加1
            $('span').text(++timer);
            //$('#p2').append("SUCC:"+res);
            //setTimeout(function () {
                qCode();
            //},2000);
        },
        error:function (res) {
            //$('#p2').append("FAIL:"+res);
        }
    });
}
</script>
</body>
</html>